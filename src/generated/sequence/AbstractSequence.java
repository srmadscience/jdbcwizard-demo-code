package com.orindasoft.demo.generated.sequence;


import java.sql.*; 
import com.orindasoft.pub.LogInterface; 
import com.orindasoft.pub.OracleResourceUser; 
import com.orindasoft.pub.CSException; 

/** 
* Abstract Sequence class used by classes generated by JDBCWizard
* 
* <p>Generated by JDBCWizard build 2814 at 2011/11/22 00:33:26.267 GMT
* <p>JDBCWizard is made by <a href="http://www.orindasoft.com/?pdsrc=GD2814" target="_blank">Orinda Software Ltd, Dublin, Ireland</a>
* <p>Target Database: Oracle 10.2.0
* <p> -------------------------------------------------------------------------
* <p> WARNING: This code will stop working around the time JDBCWizard expires.
* <p> This restriction only exists in the demo version of JDBCWizard.
* <p> -------------------------------------------------------------------------
* <p> JDBCWizard Tips 17 of 19:
* <p> JDBCWizard also runs as an extension to Oracle's JDeveloper 10g
* <p> -------------------------------------------------------------------------
* 
* <p>Copyright Orinda Software 2003-2009
* @author devteam60@orindabuild.com
* @version 1.1
*/ 
public abstract class AbstractSequence implements OracleResourceUser
{ 
  /** 
  * Constant used for object that is in this users account 
  */ 
  public static final int THIS_USERS_OBJECT = 0; 
  
  /** 
  * Constant used for object that is in an other users account 
  */ 
  public static final int OTHER_USERS_OBJECT = 1; 
  
  /** 
  * Constant used for object that is a refered to by a PRIVATE SYNONYM 
  */ 
  public static final int THIS_USERS_SYNONYM = 2; 
  
  /** 
  * Constant used for object that is a refered to by a PUBLIC SYNONYM 
  */ 
  public static final int PUBLIC_SYNONYM = 3; 
  
  /** 
  * Database Connection 
  */ 
  public Connection theConnection = null; 
  
  /** 
  * An instance of a class which implements com.orindasoft.pub.LogInterface 
  */ 
  public com.orindasoft.pub.LogInterface theLog = null; 
  
  /** 
  * Prepared statment for accessing sequence 
  */ 
  PreparedStatement seqStatement = null; 
  
  /** 
  * last value retrieved from this sequence 
  */ 
  long lastValue = Long.MIN_VALUE; 
  
  /** 
  * Create an instance of AbstractSequence using a database connection and an instance of LogInterface 
  *  @param Connection theConnection A database connection 
  *  @param LogInterface theLog An instance of a class that implements com.orindasoft.pub.LogInterface 
  */ 
  public AbstractSequence(Connection theConnection, LogInterface theLog) 
    { 
    this.theConnection = theConnection; 
    this.theLog = theLog; 
    } 
   
  /** 
  * Create an instance of AbstractSequence using an instance of LogInterface  
  *  @param LogInterface theLog An instance of a class that implements com.orindasoft.pub.LogInterface  
  */                                   
  public AbstractSequence(LogInterface theLog)      
    {                                                 
    this.theLog = theLog;                             
    }                                                  
   
  /**  
  * Set or reset the database connection 
  *  @param Connection theConnection A database connection  
  */       
  public void setConnection(Connection theConnection)  
    {                                               
    this.theConnection = theConnection;          
    }                                           
   
  /** 
  * Query to return next value from sequence. 
  */ 
  public abstract String getSequenceQuery(); 
  
  /**    
  * Get last accessed number  
  * @return long The last number we returned 
  * @return Long.MIN_VALUE if we have yet to access the sequence 
  */    
  public long getLast()  
    {                      
    return(lastValue);     
    }                      
   
  /** 
  * Get next available number 
  * @return long The latest number we got from the sequence 
  * @throws CSException A runtime error of some kind. See <a href=http://www.orindasoft.com/?pdsrc=GD2814csexeceptions>CSExceptions</a>
  */ 
  public long getNext() throws CSException    
    {    
    ResultSet tempResultSet = null;              
                                                   
    if (theConnection == null)                     
      {                                              
      throw (new CSException("Not Connected - Sequence can not be accessed"));  
      }                                                                         
                                                                            
    if (seqStatement == null)                                              
      {      
      // Parse query.    
      // Unlike getting a result set and getting the number from 
      // the result set we can't retry this. Any exceptions will be 
      // allowed to propogate 
      seqStatement = prepareSequenceQry();   
      }    
          
    try    
      {       
      // See if our statement is usable. If somebody else who has the connection has called    
      // its commit method out prepared statement may no longer be usable...        
      tempResultSet = getResultSet();    
      }                              
    catch (CSException e)          
      {                              
      // Re-parse and try again. If something happened to our connection we 
      // may be able to salvage the situation 
      theLog.warning("AbstractSequence: Execution failed with " + e.toString());
      seqStatement = prepareSequenceQry();     
      tempResultSet = getResultSet();      
      }                           
                                
    try                        
      {                          
      // get Number from sequence. it's unlikely that we'll create an exception   
      // but we allow for one anyway.  
      theLog.debug("AbstractSequence - Starting to Retrieve value");
      lastValue = tempResultSet.getLong(1);   
      tempResultSet.close();         
      theLog.debug("AbstractSequence - Retrieved value of " + lastValue );
      }                              
    catch (java.sql.SQLException e)   
      {  
      theLog.error("AbstractSequence: Retrieval failed with " + e.getMessage() );
      throw (new CSException(e.getErrorCode() + ":"+ e.toString()));   
      }                                       
                                             
    return(lastValue);                       
    }                                        
  
  protected PreparedStatement prepareSequenceQry() throws CSException     
    {                                                                   
    PreparedStatement newSeqQry;                                      
                                                                     
    // Parse query...                          
    try                                                              
      {                                                                
      theLog.debug("AbstractSequence - Starting to parse query");
      newSeqQry = theConnection.prepareStatement(getSequenceQuery());    
      theLog.debug("AbstractSequence - Finished parsing query");
      }                                                                  
    catch (java.sql.SQLException e)                                    
      {                                                                   
      theLog.error("AbstractSequence: Prepare Statement failed with " + e.toString());
      throw (new CSException("Unable to parse statement: " + e.toString()));   
      }       
              
                      
    return(newSeqQry);  
                        
    }                      
                         
  /** 
  * Issue query and get result set from database 
  * @throws CSException A runtime error of some kind. See <a href=http://www.orindasoft.com/?pdsrc=GD2814csexeceptions>CSExceptions</a>
  */ 
  protected ResultSet getResultSet() throws CSException  
    {                                    
    ResultSet newResultSet;    
                 
    try            
      {                
      theLog.debug("AbstractSequence - Starting to execute query");
      newResultSet = seqStatement.executeQuery();  
      newResultSet.next();                         
      theLog.debug("AbstractSequence - Finished executing query");
      }                                            
    catch (SQLException e)                        
      {                                             
      theLog.error("AbstractSequence: getResultSet failed with " + e.getMessage());
      throw (new CSException (e.toString()));       
      }    
          
    return(newResultSet); 
    }                     
   
  /** 
  * Release all db resources that we know to be in use. Further attempts to use this 
  *  will fail until we are given another connection to play with. 
  * We explicitly rollback at the end of this method. 
  *  @return boolean <code>true</code> if we didn't encounter any problems, otherwise <code>false</code> 
  */ 
   
  public boolean releaseResources() 
    { 
    boolean returnCode = true; 
    
    theLog.debug("AbstractSequence - Attempting to release connection");
    
    try 
      { 
      
      if (seqStatement != null)
        { 
        seqStatement.close(); 
        } 
      } 
    catch (SQLException e) 
      { 
      theLog.warning(e.toString()); 
      returnCode = false; 
      } 
    
    theConnection = null; 
    seqStatement = null; 
    theLog.debug("AbstractSequence- Finished releasing connection");
    
    return(returnCode); 
    } 
  
  /** 
  * Check to see if we are using Oracle Resources
  *  will fail until we are given another connection to play with. 
  * We explicitly rollback at the end of this method. 
  * @return <code>true</code> if we are using resources
  * @return <code>false</code> if we are not using resources
  */ 
  public boolean hasResources() 
    { 
    if (theConnection == null) 
      { 
      return (false); 
      } 
    
    return(true); 
    } 
  } // Generated by JDBCWizard 
